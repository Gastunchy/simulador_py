<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Viajes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        /* Diseño general */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            text-align: center;
            animation: fadeIn 0.5s ease-in;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        h3 {
            margin-bottom: 20px;
            font-size: 28px;
            color: #333;
        }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        button:hover {
            background-color: #0056b3;
        }

        /* Modo oscuro */
        body.dark-mode {
            background-color: #333;
            color: white;
        }
        .dark-mode .container {
            background: #444;
            box-shadow: 0 8px 16px rgba(255, 255, 255, 0.2);
        }
        .dark-mode h3, .dark-mode h4 {
            color: #f8f9fa;
        }
        .dark-mode button {
            background-color: #28a745;
        }
        .dark-mode button:hover {
            background-color: #218838;
        }
        .dark-mode .status-container {
            background-color: #555;
        }
        .dark-mode .status-message {
            color: #dee2e6;
        }
        .dark-mode .info-container {
            background-color: #555;
        }
        .dark-mode .info-item span {
            color: #dee2e6;
        }

        /* Estilos de los estados de los datos */
        #status {
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #333;
            opacity: 0;
            animation: fadeIn 1s ease-out forwards;
        }

        .status-container {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .status-container h4 {
            margin: 0;
            font-size: 18px;
            color: #343a40;
        }

        .status-message {
            font-size: 18px;
            font-weight: normal;
            color: #6c757d;
        }

        /* Animación de entrada */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Indicador de carga (barra de progreso) */
        .progress-bar {
            width: 0%;
            height: 6px;
            background-color: #28a745;
            border-radius: 3px;
            margin-top: 10px;
            transition: width 0.5s ease;
        }

        /* Toggle de modo noche/día en la esquina superior derecha */
        #toggleMode {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #f0f2f5;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #toggleMode:hover {
            background-color: #ddd;
        }

        /* Estilo para el mapa */
        #map {
            height: 400px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Info container para detalles del viaje */
        .info-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 20px;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: left;
        }

        .info-item {
            width: 48%;
            margin-bottom: 10px;
        }

        .info-item strong {
            font-weight: bold;
            color: #343a40;
        }

        .info-item span {
            color: #6c757d;
        }

        /* Estilos para la lista de eventos de telemetría */
        #telemetryEvents {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            padding: 0;
            list-style-type: none;
        }

        .telemetry-event {
            padding: 10px;
            margin-bottom: 5px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            text-align: left;
            animation: slideIn 0.3s ease-out;
        }

        .dark-mode .telemetry-event {
            background-color: #555;
            border-left: 4px solid #28a745;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-10px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h3>Simulador de Viajes</h3>
        <button id="startTripBtn" onclick="startTrip()">Iniciar Viaje</button>
        <p id="status"></p>

        <div class="status-container">
            <div>
                <h4>Viaje:</h4>
                <p id="sendingData" class="status-message">Esperando datos...</p>
            </div>
            <div>
                <h4>Telemetría:</h4>
                <p id="telemetryData" class="status-message">Esperando datos...</p>
            </div>
        </div>

        <div class="progress-bar" id="progressBar"></div>

        <!-- Info del viaje actual -->
        <div class="info-container" id="tripInfoContainer" style="display:none;">
            <div class="info-item">
                <strong>ID de Viaje:</strong> <span id="tripId">-</span>
            </div>
            <div class="info-item">
                <strong>Dominio:</strong> <span id="dominio">-</span>
            </div>
            <div class="info-item">
                <strong>Origen:</strong> <span id="origen">Córdoba</span>
            </div>
            <div class="info-item">
                <strong>Destino:</strong> <span id="destino">Rosario</span>
            </div>
            <div class="info-item">
                <strong>Transportista:</strong> <span id="transportista">-</span>
            </div>
            <div class="info-item">
                <strong>Precintos:</strong> <span id="precintos">-</span>
            </div>
            <div class="info-item">
                <strong>Estado:</strong> <span id="estado">-</span>
            </div>
            <div class="info-item">
                <strong>Última actualización:</strong> <span id="ultimaActualizacion">-</span>
            </div>
        </div>

        <!-- Mapa -->
        <div id="map"></div>

        <!-- Lista de eventos de telemetría -->
        <h4 style="margin-top: 20px; text-align: left;">Eventos de Telemetría:</h4>
        <ul id="telemetryEvents"></ul>
    </div>

    <!-- Botón para cambiar entre modo claro y oscuro -->
    <button id="toggleMode" onclick="toggleMode()">Modo Noche</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        // Variables globales
        let map = null;
        let vehicleMarker = null;
        let routePath = null;
        let routePoints = [];
        let currentTrip = null;
        let isTripActive = false;
        let pollingInterval = null;
        const MAX_TELEMETRY_EVENTS = 10;

        // Datos iniciales de viaje
        const tripData = {
            tipoViaje: "ld",
            idSucursalOrigen: "20241",
            idSucursalDestino: "20305",
            hr: "122233",
            transportista: "12254198",
            dominio: "AA227DX",
            dominioSemi: "AA800XM",
            precintos: "1238A, 18239123, FOOBAR"
        };

        // Función para cambiar entre modo oscuro y modo claro
        function toggleMode() {
            document.body.classList.toggle('dark-mode');
            const modeButton = document.getElementById('toggleMode');
            
            if (document.body.classList.contains('dark-mode')) {
                modeButton.textContent = 'Modo Día';
                // Actualizar mapa a modo oscuro si existe
                if (map) {
                    document.querySelector('.leaflet-tile-pane').style.filter = 'invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%)';
                }
            } else {
                modeButton.textContent = 'Modo Noche';
                // Restaurar mapa a modo normal si existe
                if (map) {
                    document.querySelector('.leaflet-tile-pane').style.filter = 'none';
                }
            }
        }

        // Inicializar el mapa
        function initMap() {
            if (!map) {
                // Coordenadas iniciales (Córdoba)
                const initialPos = [-31.4135, -64.1810];
                
                map = L.map('map').setView(initialPos, 10);
                
                // Añadir la capa de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Crear la ruta como una línea polilínea
                routePath = L.polyline([], { 
                    color: '#007bff',
                    weight: 5,
                    opacity: 0.7
                }).addTo(map);
                
                // Crear un marcador para el vehículo
                const truckIcon = L.divIcon({
                    html: `<div style="font-size: 24px;">🚚</div>`,
                    className: 'truck-icon',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                vehicleMarker = L.marker(initialPos, {
                    icon: truckIcon
                }).addTo(map);
                
                // Aplicar estilo oscuro si está activado
                if (document.body.classList.contains('dark-mode')) {
                    document.querySelector('.leaflet-tile-pane').style.filter = 'invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%)';
                }
            }
        }

        // Actualizar la posición del vehículo y la ruta
        function updateVehiclePosition(lat, lng, fitBounds = true) {
            if (!map) initMap();
            
            const newPos = [parseFloat(lat), parseFloat(lng)];
            
            // Actualizar posición del marcador
            vehicleMarker.setLatLng(newPos);
            
            // Añadir punto a la ruta y actualizar línea
            routePoints.push(newPos);
            routePath.setLatLngs(routePoints);
            
            // Centrar el mapa en la nueva posición
            map.panTo(newPos);
            
            // Zoom para ver toda la ruta si hay más de un punto y si se solicita
            if (fitBounds && routePoints.length > 1) {
                map.fitBounds(routePath.getBounds(), {
                    padding: [50, 50], // Margen alrededor de la ruta
                    maxZoom: 13        // Evitar zoom excesivo
                });
            }
            
            return newPos;
        }

        // Iniciar el polling para obtener actualizaciones del estado del viaje
        function startPolling(tripId) {
            // Detener cualquier polling previo
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // Función para obtener el estado actual del viaje
            const fetchTripStatus = () => {
                fetch(`/trip_status/${tripId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Viaje no encontrado');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'active') {
                            // Actualizar estado
                            document.getElementById('estado').textContent = 'En progreso';
                            
                            // Obtener telemetría
                            fetchTelemetry(tripId);
                            
                            // Si el viaje está completo, detener el polling
                            if (data.trip_info.status === 'completed') {
                                document.getElementById('estado').textContent = 'Completado';
                                
                                // Mostrar resumen de la ruta si está disponible
                                if (data.trip_info.route_summary) {
                                    const summary = data.trip_info.route_summary;
                                    document.getElementById('origen').textContent = summary.origin;
                                    document.getElementById('destino').textContent = summary.destination;
                                    
                                    // Mostrar mensaje de finalización
                                    document.getElementById('telemetryData').textContent = 
                                        `Telemetría completada. Distancia: ${summary.distance_km} km, ` +
                                        `Duración: ${summary.duration.toFixed(1)} h, ` +
                                        `Velocidad media: ${summary.avg_speed} km/h`;
                                }
                                
                                // Detener el polling
                                clearInterval(pollingInterval);
                                
                                // Habilitar botón de inicio para un nuevo viaje
                                document.getElementById('startTripBtn').disabled = false;
                            }
                        } else {
                            // El viaje ya no está activo
                            document.getElementById('estado').textContent = 'Completado';
                            document.getElementById('telemetryData').textContent = 'Telemetría finalizada';
                            
                            // Detener el polling
                            clearInterval(pollingInterval);
                            
                            // Habilitar botón de inicio para un nuevo viaje
                            document.getElementById('startTripBtn').disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error al obtener estado del viaje:', error);
                        document.getElementById('telemetryData').textContent = 'Error al obtener datos';
                        
                        // Detener el polling en caso de error
                        clearInterval(pollingInterval);
                        
                        // Habilitar botón de inicio para un nuevo viaje
                        document.getElementById('startTripBtn').disabled = false;
                    });
            };
            
            // Obtener estado inmediatamente
            fetchTripStatus();
            
            // Configurar intervalo de polling (cada 5 segundos)
            pollingInterval = setInterval(fetchTripStatus, 5000);
        }

        // Obtener eventos de telemetría
        function fetchTelemetry(tripId) {
            fetch(`/telemetry/${tripId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Datos de telemetría no disponibles');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Verificar si hay nuevos eventos
                        const events = data.telemetry;
                        const currentCount = document.getElementById('telemetryEvents').children.length;
                        
                        if (events.length > currentCount) {
                            // Hay nuevos eventos para mostrar
                            document.getElementById('telemetryData').textContent = 
                                `Recibiendo datos (${events.length} eventos)`;
                            
                            // Procesar solo los nuevos eventos (del más reciente al más antiguo)
                            for (let i = events.length - 1; i >= currentCount; i--) {
                                processTelemetryEvent(events[i]);
                            }
                            
                            // Actualizar última actualización
                            if (events.length > 0) {
                                const lastEvent = events[events.length - 1];
                                document.getElementById('ultimaActualizacion').textContent = 
                                    new Date(lastEvent.timestamp).toLocaleString();
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al obtener telemetría:', error);
                });
        }

        // Procesar un evento de telemetría
        function processTelemetryEvent(event) {
            // Actualizar posición en el mapa
            const newPos = updateVehiclePosition(
                event.position.lat, 
                event.position.long, 
                document.getElementById('telemetryEvents').children.length % 5 === 0 // Ajustar vista cada 5 eventos
            );
            
            // Añadir evento a la lista
            addTelemetryEventToList({
                time: new Date(event.timestamp).toLocaleTimeString(),
                position: `${event.position.lat.toFixed(4)}, ${event.position.long.toFixed(4)}`,
                speed: `${event.speed} km/h`,
                location: event.location || '',
                weather: event.weather || '',
                traffic: event.traffic || '',
                eventos: event.events.join(', ')
            });
        }

        // Añadir evento a la lista de telemetría
        function addTelemetryEventToList(event) {
            const eventsList = document.getElementById("telemetryEvents");
            
            // Crear elemento de lista para el nuevo evento
            const listItem = document.createElement("li");
            listItem.className = "telemetry-event";
            
            let eventHtml = `<strong>${event.time}</strong> - `;
            eventHtml += `Posición: ${event.position} - `;
            eventHtml += `Velocidad: ${event.speed}`;
            
            if (event.location) {
                eventHtml += ` - ${event.location}`;
            }
            
            if (event.weather || event.traffic) {
                eventHtml += ` (${event.weather}${event.weather && event.traffic ? ', ' : ''}${event.traffic})`;
            }
            
            if (event.eventos) {
                eventHtml += ` - Eventos: ${event.eventos}`;
            }
            
            listItem.innerHTML = eventHtml;
            
            // Añadir al principio de la lista
            eventsList.insertBefore(listItem, eventsList.firstChild);
            
            // Limitar el número de eventos mostrados
            while (eventsList.children.length > MAX_TELEMETRY_EVENTS) {
                eventsList.removeChild(eventsList.lastChild);
            }
        }

        // Iniciar un viaje
        function startTrip() {
            // Reiniciar el estado del viaje
            resetTripState();
            
            // Mostrar que se está enviando los datos de viaje
            const sendingDataElement = document.getElementById("sendingData");
            sendingDataElement.textContent = "Enviando datos de viaje...";
            
            // Mostrar en la interfaz que estamos esperando telemetría
            const telemetryDataElement = document.getElementById("telemetryData");
            telemetryDataElement.textContent = "Esperando datos de telemetría...";
            
            // Barra de progreso
            const progressBar = document.getElementById("progressBar");
            progressBar.style.width = "50%";
            
            // Deshabilitar el botón mientras se procesa
            document.getElementById("startTripBtn").disabled = true;
            
            // Enviar la solicitud de viaje
            fetch('/start_trip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tripData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al iniciar viaje');
                }
                return response.json();
            })
            .then(data => {
                // Mostrar mensaje de éxito
                document.getElementById("status").textContent = "Viaje iniciado con éxito.";
                sendingDataElement.textContent = "Datos de viaje enviados.";
                
                // Activar viaje
                isTripActive = true;
                currentTrip = {
                    id: data.id_viaje,
                    dominio: data.dominio
                };
                
                // Actualizar información del viaje
                updateTripInfo(data);
                
                // Mostrar el contenedor de info
                document.getElementById("tripInfoContainer").style.display = "flex";
                
                // Inicializar mapa si no existe
                initMap();
                
                // Iniciar polling para recibir actualizaciones
                startPolling(data.id_viaje);
                
                // Completar la barra de progreso
                progressBar.style.width = "100%";
                
                // Después de un tiempo, ocultar los mensajes de estado y la barra de progreso
                setTimeout(() => {
                    document.getElementById("status").textContent = "";
                    progressBar.style.width = "0%";
                }, 3000);
            })
            .catch(error => {
                console.error("Error al iniciar viaje:", error);
                
                document.getElementById("status").textContent = "Error al iniciar el viaje.";
                sendingDataElement.textContent = "Error al enviar los datos de viaje.";
                progressBar.style.width = "0%";
                
                // Habilitar el botón de nuevo
                document.getElementById("startTripBtn").disabled = false;
            });
        }

        // Actualizar información del viaje en la interfaz
        function updateTripInfo(data) {
            document.getElementById("tripId").textContent = data.id_viaje || "-";
            document.getElementById("dominio").textContent = data.dominio || "-";
            document.getElementById("transportista").textContent = tripData.transportista;
            document.getElementById("precintos").textContent = tripData.precintos;
            document.getElementById("estado").textContent = "En progreso";
            document.getElementById("ultimaActualizacion").textContent = new Date().toLocaleString();
        }

        // Reiniciar el estado del viaje
        function resetTripState() {
            // Detener polling si existe
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            
            // Limpiar puntos de ruta
            routePoints = [];
            
            // Limpiar ruta en el mapa si existe
            if (routePath) {
                routePath.setLatLngs([]);
            }
            
            // Limpiar eventos de telemetría
            document.getElementById("telemetryEvents").innerHTML = "";
            
            // Reiniciar viaje actual
            currentTrip = null;
            isTripActive = false;
        }

        // Inicializar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Asegurarse de que el contenedor de info esté oculto al inicio
            document.getElementById("tripInfoContainer").style.display = "none";
            
            // Inicializar el mapa para tenerlo listo
            initMap();
        });
    </script>
</body>
</html>